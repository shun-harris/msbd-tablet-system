<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Options Page</title>
</head>
<body>
  <div id="app"></div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --gold1:#f3dc8a; --gold2:#b8922a;
      --text:#f3f4f6; --muted:#c9cacc;
      --panel:#131417; --ink:#0f0f10;
      --darkBtn:#121316; --border:rgba(255,255,255,.10);
      --success:#1f3a24; --successEdge:#2a5a36;
      --warn:#2f1b12; --warnEdge:#5a3a2a;
    }
    html,body{height:100%}
    body{margin:0;background:#0f0f10;color:var(--text);font-family:Inter,system-ui,Arial}

    .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1200px 600px at 30% 10%, #1b1c20 0%, #0f1012 55%, #0c0d0f 100%);
      padding:28px 12px 60px;}
    .stack{width:min(980px,92%);margin:0 auto}

    h1{margin:6px 0 8px;font-size:clamp(34px,6.8vw,58px);font-weight:900;text-align:center}
    .sub{color:var(--muted);text-align:center;margin:0 0 24px;font-size:clamp(14px,2.6vw,18px)}

    .card{background:linear-gradient(180deg,#141519,#101114);border:1px solid var(--border);
      border-radius:16px;padding:18px;margin-top:18px;}
    .card h3{margin:2px 0 10px;font-size:18px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }

    .btn{display:flex;align-items:center;justify-content:center;gap:10px;height:74px;
      border-radius:14px;border:1px solid var(--border);font-weight:800;
      font-size:clamp(18px,3.6vw,22px);cursor:pointer;background:var(--darkBtn);color:var(--gold1);
      transition: background-color .25s ease, color .25s ease, border-color .25s ease, opacity .2s ease, transform .06s ease;}
    .btn:active{transform:scale(.99)}
    .btn-gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1b1400;border-color:transparent;}
    .btn-warn{background:linear-gradient(180deg,var(--warn),#1f1510);color:#ffd7b0;border-color:var(--warnEdge);}
    .btn-success{
      background:linear-gradient(180deg,var(--success),#162619) !important;
      color:#b9f6ce !important;
      border-color:var(--successEdge) !important;
      cursor:not-allowed !important;
      opacity:.96;
    }

    .fieldCard{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:720px){ .fieldCard{grid-template-columns:1fr} }
    .kv{background:#0f1012;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
    .kv .k{color:#a9abb0;font-size:12px;margin:0 0 6px}
    .kv .v{font-weight:700}

    .minor-row{display:flex;justify-content:center;margin-top:12px;}
    .link-btn{background:transparent;border:0;cursor:pointer;color:var(--muted);font-weight:700;
      font-size:clamp(14px,2.6vw,16px);padding:6px 10px;border-radius:10px;}
    .link-btn:hover{color:var(--gold1);background:rgba(255,255,255,.06)}

    .swap-wrap{position:relative;min-height:220px;}
    .pane{transition:opacity .22s ease,transform .22s ease;}
    .pane.hide{opacity:0;transform:translateY(8px);pointer-events:none;position:absolute;inset:0;}
    .pane.show{opacity:1;transform:none;position:relative;}

    .payTitle{text-align:center;margin:2px 0 12px;font-weight:800;opacity:.9;}

    /* QR Overlay */
    #qrOverlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
      z-index:1000;align-items:center;justify-content:center;
    }
    #qrBox{
      background:#141519;border-radius:16px;padding:22px;text-align:center;
      max-width:92%;box-shadow:0 0 40px rgba(0,0,0,.5);
    }
    #qrImg{width:320px;height:320px;display:block;margin:0 auto 16px;background:#fff;border-radius:12px;}
    /* center the overlay "I'm Done" button */
    #qrDone{ display:block; margin:14px auto 0; }

    /* Cash Modal */
    .modalOverlay{
      display:none; position:fixed; inset:0; z-index:1100;
      background:rgba(0,0,0,.85); align-items:center; justify-content:center;
    }
    .modalBox{
      background:#141519; border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:22px; max-width:min(520px,92%); text-align:center;
      box-shadow:0 0 40px rgba(0,0,0,.5);
    }
    .modalBox h3{ margin:0 0 8px; font-size:20px; font-weight:900; }
    .modalBox p{ margin:0 0 14px; color:#cfd3da; }
    .modalBox .btn{ height:auto; padding:12px 28px; font-size:18px; border-radius:10px; margin:0 auto; display:inline-flex; }
  </style>

  <script>
    // ===== Auto Toggle Live/Dev =====
    const DEV =
      location.hostname === 'localhost' ||
      location.hostname === '127.0.0.1' ||
      location.hostname === '0.0.0.0' ||
      location.hostname === '::1' ||
      location.protocol === 'file:'; // double-clicking an .html file

    const TEST = location.hostname === 'test.tablet.msbdance.com';

    // ===== Settings =====
    const SETTINGS = {
      HOME_URL: DEV
        ? './index.html'
        : TEST
        ? 'https://test.tablet.msbdance.com/'
        : 'https://tablet.msbdance.com/',
      OPTIONS_URL: DEV
        ? './options.html'
        : TEST
        ? 'https://test.tablet.msbdance.com/options.html'
        : 'https://tablet.msbdance.com/options.html',
    };

    (function(){
      const MAKE_ROUTE_URL="https://hook.us1.make.com/7o1igxij7s24myaep5mtc5k6fvxunqh8";
      const GHL_WEBHOOK_URL="https://services.leadconnectorhq.com/hooks/3RfSeF58PmlwTx5aIQ0a/webhook-trigger/1b53b6bb-c54a-45d9-8f47-7816dd36cab0";
      const CLASS_NAME="Salsa Basics";
      const $=(s,r=document)=>r.querySelector(s);

      const qs=new URLSearchParams(location.search);
      const phone=(qs.get("phone")||"").replace(/\D/g,"").slice(-10);
      const name=(qs.get("name")||"").trim();
      const back=qs.get("back")||"";
      const ctx={kind:null};

      const escapeHtml=s=>String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

      function sendGHLCheckin(phone){
        if (!phone) return;
        const u=`${GHL_WEBHOOK_URL}?phone=${encodeURIComponent(phone)}&evt=free_salsa_basics&src=tablet&ts=${Date.now()}`;
        new Image().src=u;
      }
      async function routeViaMakeDirect({phone,name,product}){
        try{
          const r=await fetch(MAKE_ROUTE_URL,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({phone,name,product,src:"tablet",ts:Date.now()})});
          if(!r.ok) return null;
          const d=await r.json().catch(()=>null);
          return d && d.url ? d.url : null;
        }catch(_){return null;}
      }

      function show(el){el.classList.remove("hide");el.classList.add("show");}
      function hide(el){el.classList.remove("show");el.classList.add("hide");}

      function showQr(url){
        const qrOverlay=$("#qrOverlay"),qrImg=$("#qrImg");
        qrImg.src=`https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(url)}`;
        qrOverlay.style.display="flex";
        try{confetti({particleCount:80,spread:60,origin:{y:.6}});}catch(_){}
      }

      function showCashModal(){
        const el=$("#cashOverlay");
        el.style.display="flex";
        try{confetti({particleCount:40,spread:50,origin:{y:.6}});}catch(_){}
        $("#cashOk").onclick=()=>{location.href="https://msbdance.com/tablet";};
      }

      function renderMain(){
        document.getElementById("app").innerHTML=`
          <div class="stage"><div class="stack">
            <h1>Welcome${name?`, ${escapeHtml(name)}`:""}!</h1>
            <p class="sub">You're all set — pick an option below.</p>
            <div class="card">
              <div class="swap-wrap">
                <div id="panePrimary" class="pane show">
                  <h3>Quick Actions</h3>
                  <div class="grid2">
                    <button id="btnCheck" class="btn">Check in: ${escapeHtml(CLASS_NAME)}</button>
                    <button id="btnSingle" class="btn">Buy a Single Class</button>
                  </div>
                  <div class="grid2" style="margin-top:14px">
                    <button id="btnMembership" class="btn btn-gold">Buy Unlimited (Membership)</button>
                    <button id="btnDone" class="btn" style="color:#e5e7eb">Done</button>
                  </div>
                </div>
                <div id="panePay" class="pane hide">
                  <div class="payTitle" id="payTitle"></div>
                  <div class="grid2" id="payOptions"></div>
                  <div class="grid2" style="margin-top:14px">
                    <button id="payBack" class="btn">← Back</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card"><div class="fieldCard">
              <div class="kv"><div class="k">Guest</div><div class="v">${name||"—"}</div></div>
              <div class="kv"><div class="k">Phone</div><div class="v">${phone||"—"}</div></div>
            </div></div>
            <div class="minor-row"><button id="notMeGoBack" class="link-btn">Not me</button></div>
          </div></div>

          <!-- QR Overlay -->
          <div id="qrOverlay">
            <div id="qrBox">
              <img id="qrImg" alt="Scan to pay">
              <button id="qrDone" class="btn btn-gold">I’m Done</button>
            </div>
          </div>

          <!-- Cash Modal -->
          <div id="cashOverlay" class="modalOverlay">
            <div class="modalBox">
              <h3>Pay with cash</h3>
              <p>Please head to registration to finish your purchase.</p>
              <button id="cashOk" class="btn btn-gold">OK</button>
            </div>
          </div>`;

        // wire buttons
        const panePrimary=$("#panePrimary"),panePay=$("#panePay");
        const payTitle=$("#payTitle"),payOptions=$("#payOptions");
        if(back) $("#notMeGoBack").onclick=()=>{location.href=back}; else $("#notMeGoBack").style.display="none";

        // CHECK-IN button: fade green + lock
        $("#btnCheck").onclick=()=>{ 
          if(!phone) return; 
          const b=$("#btnCheck");
          b.disabled=true;
          b.textContent="Checking in…";
          b.classList.add("btn-success");
          sendGHLCheckin(phone);
          setTimeout(()=>{ 
            try{confetti({particleCount:120,spread:70,origin:{y:.6}});}catch(_){} 
            b.textContent="Checked in ✓";
          },180);
        };

        // Done → live home
        const doneButton = $("#btnDone");
        if (doneButton) {
          doneButton.onclick = () => {
            console.log("Button clicked"); // Log button click
            console.log("DEV mode:", DEV); // Log DEV mode status

            // Redirect logic
            location.href = SETTINGS.HOME_URL;
          };
        } else {
          console.error("Done button not found"); // Log error if button is missing
        }

        function openPayPane(kind){
          ctx.kind=kind;
          payTitle.textContent=(kind==="membership")?"Unlimited (Membership) — choose a payment method":"Single Class — choose a payment method";
          let buttons=`
            <button id="payCard" class="btn btn-gold">Enter card info</button>
            <button id="payQR" class="btn">Pay on phone (QR)</button>`;
          if(kind!=="membership"){buttons+=`<button id="payCash" class="btn btn-warn">Pay with cash</button>`;}
          payOptions.innerHTML=buttons;
          hide(panePrimary);show(panePay);

          $("#payBack").onclick=()=>{hide(panePay);show(panePrimary)};
          $("#payCard").onclick=async()=>{
            const product=(ctx.kind==="membership")?"membership":"single";
            let url=await routeViaMakeDirect({phone,name,product});
            if(url) window.location.href=url; else alert("Checkout unavailable.");
          };
          $("#payQR").onclick=async()=>{
            const btn=$("#payQR");btn.textContent="Generating QR…";btn.disabled=true;
            const product=(ctx.kind==="membership")?"membershipqr":"singleqr";
            let url=await routeViaMakeDirect({phone,name,product});
            btn.textContent="Pay on phone (QR)";btn.disabled=false;
            if(url) showQr(url); else alert("QR unavailable.");
          };
          if($("#payCash")) $("#payCash").onclick=showCashModal;
        }
        $("#btnSingle").onclick=()=>openPayPane("single");
        $("#btnMembership").onclick=()=>openPayPane("membership");

        // Overlay close goes back to home (main input page)
        $("#qrDone").onclick=()=>{ location.href = "https://msbdance.com/tablet"; };

        // Fix 'Not me' button logic
        if (back) {
          const notMeButton = $("#notMeGoBack");
          notMeButton.onclick = () => {
            let dest = SETTINGS.HOME_URL; // Default fallback
            try {
              const decodedBack = decodeURIComponent(back);
              if (/^https?:\/\//i.test(decodedBack)) {
                dest = decodedBack;
              }
            } catch (error) {
              console.error("Failed to decode 'back' parameter:", error);
            }
            location.href = dest;
          };
        } else {
          $("#notMeGoBack").style.display = "none";
        }
      }

      renderMain();
    })();
  </script>
</body>
</html>
